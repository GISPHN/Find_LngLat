<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Find LngLat + 地区踏査モード開始</title>
  <!-- MapLibre GL CSS -->
  <link
    href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <!-- Font Awesome（現在地アイコンなど） -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    integrity="sha512-fa8dsp+MxFf43utQyWbr0v4qEAz1zHUGaNJ8M0bDzfrBms9D8h/xVEqdnt2bl6v0kOk9FSOcTpDu7AJ6bHguag=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <style>
    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      position: relative;
    }
    /* 既存の説明文(変更なし)を想定した details */
    details summary {
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    #info-details {
      padding: 5px 10px;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ccc;
    }

    /* 操作パネル */
    #controls-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px;
      gap: 10px;
    }
    .control-group {
      background-color: rgba(255, 255, 255, 0.8);
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #search-input {
      width: 200px; height: 30px;
      font-size: 16px; padding: 5px;
    }
    #search-button,
    #tansa-start-button,
    #register-button,
    #stop-button {
      height: 34px; font-size: 14px;
      padding: 5px 12px; cursor: pointer;
    }
    #style-select {
      height: 34px; font-size: 14px; cursor: pointer;
    }

    /* 地図エリア */
    #map {
      width: 100%; height: 65vh;
      position: relative;
    }

    /* 現在地ボタン (左下) */
    #get-location-button {
      position: absolute;
      bottom: 10px; left: 10px;
      z-index: 999;
      width: 60px; height: 60px;
      border-radius: 50%;
      background-color: transparent;
      border: 2px solid #444;
      color: #444;
      font-size: 26px;
      display: flex; justify-content: center; align-items: center;
      cursor: pointer; transition: all 0.3s;
    }
    #get-location-button.active {
      background-color: #87CEFA;
      color: #fff;
      border: none;
    }

    /* ポップアップ */
    .custom-popup {
      background-color: white;
      border: 1px solid black;
      padding: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.8s ease;
    }
    .fade-out { opacity: 0 !important; }

    /* トースト(座標コピーなど) */
    .copy-toast {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translate(-50%, -10%);
      background-color: rgba(0, 0, 0, 0.7);
      color: #ffffff;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 14px;
      opacity: 0; transition: opacity 0.5s, transform 0.5s;
      z-index: 9999;
    }
    .copy-toast.visible {
      opacity: 1; transform: translate(-50%, 0);
    }

    /* 出力モーダル (GPX/KML) */
    #export-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center;
      z-index: 99999;
    }
    #export-modal-content {
      background: #fff; padding: 20px; border-radius: 8px; max-width: 300px;
      text-align: center;
    }
    #export-modal-buttons {
      margin-top: 15px;
      display: flex; flex-wrap: wrap; /* ボタンを並べる */
      gap: 10px; /* ボタン間を広げる */
      justify-content: center;
    }
    /* 出力選択画面(ボタン大きく) */
    #export-modal-buttons button {
      font-size: 18px; /* iOSでも見やすく */
      padding: 8px 16px; /* 間隔を広めに */
      cursor: pointer;
    }

    /* タグ選択モーダル (既存) */
    #tag-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center;
      z-index: 99999;
    }
    #tag-modal-content {
      background: #fff; padding: 20px; border-radius: 8px; max-width: 400px;
      text-align: center;
    }
    #tag-list {
      display: flex; flex-direction: column; align-items: flex-start;
      margin-top: 10px;
      gap: 10px; /* ボタン間隔を広げる */
    }
    /* タグボタン大きく */
    #tag-list button {
      font-size: 18px; /* iOSでも見やすく */
      padding: 8px 16px;
      cursor: pointer;
    }
    /* スキップボタンも同じく */
    #tag-cancel {
      font-size: 18px; padding: 8px 16px; margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- 既存の説明文(変更しない想定) -->
  <details id="info-details" open>
    <summary>Find LngLat (説明を表示/非表示)</summary>
    <p>
      ここに既存の説明文が入る。<br/>
      （今回は変更しないとのこと）
    </p>
  </details>

  <!-- 操作パネル -->
  <div id="controls-container">
    <div class="control-group">
      <input type="text" id="search-input" placeholder="施設名や住所..." />
      <button id="search-button">検索</button>
    </div>

    <div class="control-group">
      <label for="style-select">地図スタイル：</label>
      <select id="style-select">
        <option value="https://tile.openstreetmap.jp/styles/osm-bright/style.json">OSM Bright</option>
        <option value="https://raw.githubusercontent.com/armd-02/Playgrounds/main/tiles/osmfj_poi.json">OSMFJ POI</option>
        <option value="https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg">全国最新写真</option>
      </select>
    </div>

    <!-- 1) 地区踏査モードの文言を「地区踏査モード開始」に変更 -->
    <div class="control-group">
      <button id="tansa-start-button">地区踏査モード開始</button>
      <button id="register-button">登録</button>
      <button id="stop-button">終了</button>
    </div>
  </div>

  <!-- 地図本体 -->
  <div id="map">
    <!-- 現在地ボタン -->
    <button id="get-location-button" title="現在地">
      <i class="fas fa-location-arrow"></i>
    </button>
  </div>

  <!-- 出力モーダル -->
  <div id="export-modal">
    <div id="export-modal-content">
      <p>記録を終了しました。ファイルをダウンロードしますか？</p>
      <div id="export-modal-buttons">
        <button id="download-gpx">GPX</button>
        <button id="download-kml">KML</button>
        <button id="export-close">閉じる</button>
      </div>
    </div>
  </div>

  <!-- タグ選択モーダル(既存) -->
  <div id="tag-modal">
    <div id="tag-modal-content">
      <p>タグを選択してください（1つだけ）。<br/>スキップも可能です。</p>
      <div id="tag-list">
        <button data-tag="行政と政治">1.行政と政治</button>
        <button data-tag="人口統計">2.人口統計</button>
        <button data-tag="歴史、民族性、価値観">3.歴史、民族性、価値観</button>
        <button data-tag="物理的環境">4.物理的環境</button>
        <button data-tag="保健医療と社会福祉">5.保健医療と社会福祉</button>
        <button data-tag="経済">6.経済</button>
        <button data-tag="交通と安全">7.交通と安全</button>
        <button data-tag="教育・レクリエーション">8.教育・レクリエーション</button>
        <button data-tag="情報とコミュニケーション">9.情報とコミュニケーション</button>
      </div>
      <button id="tag-cancel">スキップ</button>
    </div>
  </div>

  <!-- MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    /* ============================================================
       0) visibilitychange で スリープ復帰を検知 → 次の点は点線
    ============================================================ */
    let nextPointIsResume = false;
    document.addEventListener('visibilitychange', () => {
      // 画面が非表示→再表示になったとき
      if (!document.hidden) {
        // 次の位置取得は「点線」ブリッジ扱いに
        nextPointIsResume = true;
      }
    });

    /* ============================================================
       1) Map 初期化
    ============================================================ */
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://tile.openstreetmap.jp/styles/osm-bright/style.json',
      center: [135.5022, 34.6937],
      zoom: 13
    });

    // ラスタ/ベクトル切り替え (省略)

    /* ============================================================
       2) 検索(Nominatim)
    ============================================================ */
    // 省略: doSearch()など

    /* ============================================================
       3) 右クリックで座標コピー
    ============================================================ */
    // 省略: map.on('contextmenu', ...)

    /* ============================================================
       4) 現在地ボタン
    ============================================================ */
    // 省略: #get-location-button

    /* ============================================================
       5) 軌跡(実線+点線) のためのソースを2つ用意
          - solidLineSource: 通常取得(継続)の実線
          - dottedLineSource: スリープ復帰後の1回限りブリッジ用
    ============================================================ */
    let solidLineSource = {
      type: 'geojson',
      data: {
        type: 'Feature',
        geometry: { type: 'LineString', coordinates: [] }
      }
    };
    let solidLineLayer = {
      id: 'solid-line-layer',
      type: 'line',
      source: 'solid-line-source',
      paint: {
        'line-color': '#0000ff', // 青
        'line-width': 3
      }
    };

    let dottedLineSource = {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: [] // ここに { type:'Feature', geometry:{type:'LineString', coordinates: [...]} } を追加していく
      }
    };
    let dottedLineLayer = {
      id: 'dotted-line-layer',
      type: 'line',
      source: 'dotted-line-source',
      paint: {
        'line-color': '#0000ff',
        'line-width': 3,
        'line-dasharray': [2,2] // 点線
      }
    };

    map.on('load', () => {
      // 実線
      if (!map.getSource('solid-line-source')) {
        map.addSource('solid-line-source', solidLineSource);
      }
      if (!map.getLayer('solid-line-layer')) {
        map.addLayer(solidLineLayer);
      }
      // 点線
      if (!map.getSource('dotted-line-source')) {
        map.addSource('dotted-line-source', dottedLineSource);
      }
      if (!map.getLayer('dotted-line-layer')) {
        map.addLayer(dottedLineLayer);
      }
    });

    function addSolidLinePoint(lng, lat) {
      let coords = solidLineSource.data.geometry.coordinates;
      coords.push([ lng, lat ]);
      map.getSource('solid-line-source').setData(solidLineSource.data);
    }
    function addDottedLineSegment(prevLng, prevLat, lng, lat) {
      // 1本のLineStringを追加
      dottedLineSource.data.features.push({
        type: 'Feature',
        geometry: {
          type: 'LineString',
          coordinates: [ [prevLng, prevLat], [lng, lat] ]
        }
      });
      map.getSource('dotted-line-source').setData(dottedLineSource.data);
    }
    // クリア時に dottedLineSource.data.features = []

    /* ============================================================
       6) 地区踏査モード: 文言を「地区踏査モード開始」に変更
          押下時にアラート表示
    ============================================================ */
    let trackIntervalId = null;
    let lastPoint = null; // 前回の位置

    document.getElementById('tansa-start-button').addEventListener('click', () => {
      // 2) モード開始押下時にメッセージを表示
      alert("この画面がスリープ、ロック、スマホのホーム画面になると位置情報の取得が一時停止します。\n継続的に取得したい場合はスリープをオフにして常に表示してください");

      // 例: trackIntervalIdスタートなどは従来どおり
      // ここでは簡易的に 5秒ごとの位置取得を開始する例
      if (trackIntervalId) clearInterval(trackIntervalId);
      // 既存のラインを初期化
      solidLineSource.data.geometry.coordinates = [];
      dottedLineSource.data.features = [];
      map.getSource('solid-line-source').setData(solidLineSource.data);
      map.getSource('dotted-line-source').setData(dottedLineSource.data);
      lastPoint = null;
      nextPointIsResume = false; // 画面復帰検知フラグ初期化

      trackIntervalId = setInterval(() => {
        doTrackUpdate();
      }, 5000);
      alert("地区踏査モードを開始しました。（5秒間隔で取得）");
    });

    // 位置取得してラインを更新
    function doTrackUpdate() {
      if (!navigator.geolocation) {
        console.error("Geolocation not supported");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          // 復帰後1回目なら dottedLine にブリッジ
          if (lastPoint && nextPointIsResume) {
            addDottedLineSegment(lastPoint.lng, lastPoint.lat, lng, lat);
            nextPointIsResume = false;
          } else {
            // 通常の継続実線に追加
            addSolidLinePoint(lng, lat);
          }
          lastPoint = { lat, lng };
        },
        (err) => { console.error("位置取得失敗:", err); },
        { enableHighAccuracy: true }
      );
    }

    // 「登録」ボタン, 「終了」ボタンなどは従来コードを想定
    // ...
    document.getElementById('register-button').addEventListener('click', () => {
      // ...
      // 省略: 従来どおりのコメント+タグ入力など
    });
    document.getElementById('stop-button').addEventListener('click', () => {
      if (trackIntervalId) {
        clearInterval(trackIntervalId);
        trackIntervalId = null;
      }
      // ...
      // 省略: 終了時の出力モーダル表示など
    });

    /* ============================================================
       7) タグ選択モーダル: ボタン間隔＆文字を大きく
          → CSSですでに font-size:18px; gap:10px; に修正
    ============================================================ */
    // 省略: showTagModal()など

    /* ============================================================
       8) 出力モーダルボタンの文字も大きく
          → CSSで font-size: 18px;
    ============================================================ */

    /* ============================================================
       9) トースト表示(座標コピーなど) (既存)
    ============================================================ */
    function showToast(msg) {
      const old = document.querySelector('.copy-toast');
      if (old) old.remove();

      const toast = document.createElement('div');
      toast.className = 'copy-toast';
      toast.textContent = msg;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('visible'), 10);
      setTimeout(() => toast.classList.remove('visible'), 2000);
      setTimeout(() => {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 3000);
    }
  </script>
</body>
</html>
