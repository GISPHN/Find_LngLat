<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Find LngLat + Field Survey</title>
  <!-- MapLibre GL CSS -->
  <link
    href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <!-- Font Awesome（Xアイコン用） -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    integrity="sha512-fa8dsp+MxFf43utQyWbr0v4qEAz1zHUGaNJ8M0bDzfrBms9D8h/xVEqdnt2bl6v0kOk9FSOcTpDu7AJ6bHguag=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    /* 折りたたみ用 detailsタグ */
    details summary {
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      outline: none;
      margin-bottom: 5px;
    }
    #info-details {
      padding: 5px 10px;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ccc;
    }

    /* コントロール類をまとめるコンテナ */
    #controls-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px;
      gap: 10px;
    }
    .control-group {
      background-color: rgba(255, 255, 255, 0.8);
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #search-input {
      width: 200px;
      height: 30px;
      font-size: 16px;
      padding: 5px;
    }
    #search-button,
    #get-location-button,
    #tansa-mode-button,
    #start-button,
    #register-button,
    #stop-button {
      height: 30px;
      font-size: 14px;
      padding: 5px 10px;
      cursor: pointer;
    }
    #style-select {
      height: 32px;
      font-size: 14px;
      cursor: pointer;
    }

    /* 地図表示領域 */
    #map {
      width: 100%;
      height: 70vh; /* 地図の高さをやや下げて、上部のUIスペース確保 */
    }

    /* 「地区踏査モード」の拡張ボタン群を初期は非表示 */
    #tansa-controls {
      display: none;
      gap: 5px;
    }

    /* カスタムポップアップ */
    .custom-popup {
      background-color: white;
      border: 1px solid black;
      padding: 6px;
      font-size: 14px;
      cursor: pointer; 
      transition: opacity 0.8s ease; /* フェードアウト用 */
    }
    .fade-out {
      opacity: 0 !important;
    }

    /* トースト（コピー完了メッセージ）用スタイル */
    .copy-toast {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translate(-50%, -10%);
      background-color: rgba(0, 0, 0, 0.7);
      color: #ffffff;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      z-index: 9999;
    }
    .copy-toast.visible {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  </style>
</head>
<body>
  <!-- 説明文をdetailsタグで折りたたみ可能に -->
  <details id="info-details" open>
    <summary>Find LngLat (クリックで説明表示/非表示)</summary>
    <p>
      このページでは任意地点の緯度経度をコピペできます。<br />
      使い方：検索ボックスで検索するか、地図を動かして
      <strong>クリック</strong>すると、座標をコピーできます。<br />
      利用地図：OpenStreetMap(©OpenStreetMap Contributors),
      <a href="https://github.com/armd-02/Playgrounds/tree/main/tiles" target="_blank" rel="noopener">
        osmfj_poi.json(K-Sakanoshita)
      </a><br />
      利用API：OpenStreetMap Nominatim APIを利用しています。<br />
      作成者：
      <a href="https://x.com/GISPHN" target="_blank" rel="noopener">
        <i class="fa-brands fa-x-twitter"></i> @GISPHN
      </a>
    </p>
  </details>

  <!-- ユーザー操作系をまとめる -->
  <div id="controls-container">
    <!-- 検索ボックス -->
    <div class="control-group">
      <input
        type="text"
        id="search-input"
        placeholder="施設名や住所を入力..."
      />
      <button id="search-button">検索</button>
    </div>

    <!-- 地図スタイル切り替え -->
    <div class="control-group">
      <label for="style-select">地図スタイル：</label>
      <select id="style-select">
        <option value="https://tile.openstreetmap.jp/styles/osm-bright/style.json">
          OSM Bright
        </option>
        <option value="https://raw.githubusercontent.com/armd-02/Playgrounds/main/tiles/osmfj_poi.json">
          OSMFJ POI
        </option>
      </select>
    </div>

    <!-- 現在地を取得するボタン -->
    <div class="control-group">
      <button id="get-location-button">現在地</button>
    </div>

    <!-- 地区踏査モードのオンオフボタン -->
    <div class="control-group">
      <button id="tansa-mode-button">地区踏査モード</button>
    </div>

    <!-- 地区踏査モードの拡張ボタン群（非表示→表示に切り替え） -->
    <div class="control-group" id="tansa-controls">
      <button id="start-button">スタート</button>
      <button id="register-button">登録</button>
      <button id="stop-button">終了</button>
    </div>
  </div>

  <!-- 地図表示領域 -->
  <div id="map"></div>

  <!-- MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    /* --------------------------------------------------------------------
       1) 地図初期化、基本機能
    -------------------------------------------------------------------- */
    const INITIAL_STYLE = 'https://tile.openstreetmap.jp/styles/osm-bright/style.json';
    const map = new maplibregl.Map({
      container: 'map',
      style: INITIAL_STYLE,
      center: [135.5022, 34.6937], // 大阪市近辺
      zoom: 13
    });

    // スタイル切り替え
    const styleSelect = document.getElementById('style-select');
    styleSelect.addEventListener('change', () => {
      const newStyleUrl = styleSelect.value;
      map.setStyle(newStyleUrl);
    });

    /* -----------------------------------------
       クリックで座標を取得 → ポップアップ
    ----------------------------------------- */
    map.on('click', (e) => {
      const lng = e.lngLat.lng.toFixed(6);
      const lat = e.lngLat.lat.toFixed(6);

      // 既存のポップアップを削除
      document.querySelectorAll('.maplibregl-popup').forEach(p => p.remove());

      // ポップアップ生成
      const popup = new maplibregl.Popup({ closeOnClick: false })
        .setLngLat([lng, lat])
        .setHTML(`
          <div class="custom-popup">
            Lat: ${lat}, Lng: ${lng}<br>(クリックでコピー)
          </div>
        `)
        .addTo(map);

      // ポップアップ上を再度クリック (タップ) → クリップボードコピー
      setTimeout(() => {
        const popupContent = popup.getElement().querySelector('.custom-popup');
        if (!popupContent) return;
        popupContent.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(`${lat}, ${lng}`);
            showCopyToast('クリップボードにコピーしました！');
            popupContent.classList.add('fade-out');
            setTimeout(() => popup.remove(), 800);
          } catch (err) {
            alert('コピーに失敗しました: ' + err);
          }
        });
      }, 100);
    });


    /* -----------------------------------------
       検索機能 (Nominatim API)
    ----------------------------------------- */
    document.getElementById('search-button').addEventListener('click', () => {
      performSearch();
    });
    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performSearch();
    });

    async function performSearch() {
      const query = document.getElementById('search-input').value.trim();
      if (!query) return;

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Network response was not OK');
        const data = await response.json();
        if (data.length === 0) {
          alert('該当する場所が見つかりませんでした。');
          return;
        }
        const result = data[0];
        const lat = parseFloat(result.lat);
        const lon = parseFloat(result.lon);

        map.setCenter([lon, lat]);
        map.setZoom(16);

        new maplibregl.Popup({ closeOnClick: true })
          .setLngLat([lon, lat])
          .setHTML(`<div class="custom-popup">${result.display_name}</div>`)
          .addTo(map);

      } catch (error) {
        console.error('Error:', error);
        alert('検索に失敗しました。');
      }
    }


    /* --------------------------------------------------------------------
       2) 現在地を取得して地図上に表示
    -------------------------------------------------------------------- */
    document.getElementById('get-location-button').addEventListener('click', async () => {
      if (!navigator.geolocation) {
        alert("このブラウザでは位置情報が取得できません。");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          map.setCenter([lng, lat]);
          map.setZoom(16);

          // 既存の現在地マーカーがある場合は削除 (一例)
          if (window._currentLocationMarker) {
            window._currentLocationMarker.remove();
          }
          // 新しいマーカーを置く
          window._currentLocationMarker = new maplibregl.Marker({ color: "blue" })
            .setLngLat([lng, lat])
            .addTo(map);
        },
        (err) => {
          alert("現在地の取得に失敗: " + err.message);
        },
        { enableHighAccuracy: true }
      );
    });


    /* --------------------------------------------------------------------
       3) 地区踏査モードの各種機能
    -------------------------------------------------------------------- */

    // 「地区踏査モード」ボタンを押すと、スタート・登録・終了のボタンを表示切り替え
    const tansaControls = document.getElementById('tansa-controls');
    document.getElementById('tansa-mode-button').addEventListener('click', () => {
      if (tansaControls.style.display === 'none') {
        tansaControls.style.display = 'flex'; // 表示
      } else {
        tansaControls.style.display = 'none'; // 非表示
      }
    });

    let watchId = null;
    let pathCoordinates = []; // {lat, lng, time, comment?}を格納

    // スタートボタン → 位置情報を監視し、軌跡を保存
    document.getElementById('start-button').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert("このブラウザでは位置情報を取得できません。");
        return;
      }
      pathCoordinates = [];
      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const time = Date.now();
          pathCoordinates.push({ lat, lng, time });
          // TODO: 地図上にLineLayerなどで軌跡を描画したければ追加実装
        },
        (err) => {
          console.error(err);
          alert("位置情報の取得に失敗しました。");
        },
        { enableHighAccuracy: true }
      );
      alert("踏査の記録をスタートします。");
    });

    // 登録ボタン → コメント付きピンを立てる
    document.getElementById('register-button').addEventListener('click', () => {
      if (pathCoordinates.length === 0) {
        alert("まだ位置情報が取得されていません。スタートボタンを押してください。");
        return;
      }
      // 現在の最新位置
      const lastPos = pathCoordinates[pathCoordinates.length - 1];
      if (!lastPos) return;

      const userComment = prompt("コメントを入力してください");
      if (!userComment) return;

      lastPos.comment = userComment;

      // 地図上にピンを立てる
      new maplibregl.Marker({ color: "red" })
        .setLngLat([lastPos.lng, lastPos.lat])
        .setPopup(new maplibregl.Popup().setHTML(userComment))
        .addTo(map);

      alert("コメント付きピンを登録しました。");
    });

    // 終了ボタン → 記録停止 & ファイル出力
    document.getElementById('stop-button').addEventListener('click', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (pathCoordinates.length === 0) {
        alert("軌跡がありません。");
        return;
      }

      // GPX/KMLを作成し、ユーザーにダウンロードしてもらう
      const gpxData = generateGPX(pathCoordinates);
      const kmlData = generateKML(pathCoordinates);

      // ダウンロード or 保存先を選ばせる (簡易実装)
      // とりあえず2つのファイルを連続でダウンロードする例
      if (confirm("踏査が終了しました。GPXをダウンロードしますか？")) {
        downloadFile(gpxData, "track.gpx", "application/gpx+xml");
      }
      if (confirm("KMLをダウンロードしますか？")) {
        downloadFile(kmlData, "track.kml", "application/vnd.google-earth.kml+xml");
      }

      alert("記録を終了しました。");
      pathCoordinates = [];
    });


    /* --------------------------------------------------------------------
       4) GPX / KML 生成 & ダウンロード
    -------------------------------------------------------------------- */
    function generateGPX(coords) {
      // coords: Array<{lat, lng, time, comment?}>
      let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="FindLngLat" xmlns="http://www.topografix.com/GPX/1/1">
  <trk><trkseg>
`;
      coords.forEach(c => {
        gpx += `    <trkpt lat="${c.lat}" lon="${c.lng}">
      <time>${new Date(c.time).toISOString()}</time>
      <desc>${c.comment || ''}</desc>
    </trkpt>\n`;
      });
      gpx += `  </trkseg></trk>
</gpx>`;
      return gpx;
    }

    function generateKML(coords) {
      // KMLも同様にXMLを組み立て
      // coords: Array<{lat, lng, time, comment?}>
      let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
  <name>Track</name>
  <Placemark>
    <name>軌跡</name>
    <Style>
      <LineStyle><color>ff0000ff</color><width>4</width></LineStyle>
    </Style>
    <LineString>
      <coordinates>
`;
      coords.forEach(c => {
        kml += `        ${c.lng},${c.lat},0\n`;
      });
      kml += `      </coordinates>
    </LineString>
  </Placemark>
`;
      // 各コメント付きポイントを Placemark としても出力
      coords.forEach(c => {
        if (c.comment) {
          kml += `  <Placemark>
    <name>${c.comment}</name>
    <description>${new Date(c.time).toISOString()}</description>
    <Point>
      <coordinates>${c.lng},${c.lat},0</coordinates>
    </Point>
  </Placemark>
`;
        }
      });

      kml += `</Document>
</kml>`;
      return kml;
    }

    function downloadFile(fileContent, fileName, mimeType) {
      const blob = new Blob([fileContent], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = fileName; 
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }


    /* --------------------------------------------------------------------
       5) トースト表示 (座標コピー完了など)
    -------------------------------------------------------------------- */
    function showCopyToast(message) {
      const oldToast = document.querySelector('.copy-toast');
      if (oldToast) document.body.removeChild(oldToast);

      const toast = document.createElement('div');
      toast.className = 'copy-toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('visible'), 10);
      setTimeout(() => toast.classList.remove('visible'), 2000);
      setTimeout(() => {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 3000);
    }
  </script>
</body>
</html>
