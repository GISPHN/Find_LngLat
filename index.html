<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Find LngLat</title>
  <!-- MapLibre GL CSS -->
  <link
    href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <!-- Font Awesome（Xアイコン用） -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    integrity="sha512-fa8dsp+MxFf43utQyWbr0v4qEAz1zHUGaNJ8M0bDzfrBms9D8h/xVEqdnt2bl6v0kOk9FSOcTpDu7AJ6bHguag=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    /* ページ上部の説明文 */
    #info-container {
      padding: 10px;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ccc;
      line-height: 1.6;
    }
    #info-container a {
      color: #0066cc;
      text-decoration: none;
    }
    #info-container a:hover {
      text-decoration: underline;
    }

    /* タイトルを大きくして目立たせる */
    #info-container h1 {
      margin: 0 0 10px 0;
      font-size: 1.6rem;
      font-weight: bold;
    }

    /* 検索ボックス等をまとめるコンテナ */
    #controls-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px;
      gap: 10px; /* 要素間の隙間 */
    }

    /* 個々のコンテナで区切り（検索エリア、スタイル選択） */
    .control-group {
      background-color: rgba(255, 255, 255, 0.8);
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #search-input {
      width: 200px;
      height: 30px;
      font-size: 16px;
      padding: 5px;
    }

    #search-button {
      height: 30px;
      font-size: 14px;
      padding: 5px 10px;
      cursor: pointer;
    }

    #style-select {
      height: 32px;
      font-size: 14px;
      cursor: pointer;
    }

    /* 地図表示領域 */
    #map {
      width: 100%;
      height: 80vh;
    }

    /* カスタムポップアップ */
    .custom-popup {
      background-color: white;
      border: 1px solid black;
      padding: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.8s ease; /* フェードアウト用 */
    }
    .fade-out {
      opacity: 0 !important;
    }

    /* トースト（コピー完了メッセージ）用スタイル */
    .copy-toast {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translate(-50%, -10%);
      background-color: rgba(0, 0, 0, 0.7);
      color: #ffffff;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      z-index: 9999;
    }
    .copy-toast.visible {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  </style>
</head>
<body>
  <!-- 上部説明文 -->
  <div id="info-container">
    <h1>Find LngLat</h1>
    <p>
      このページでは任意地点の緯度経度をコピペできます。<br />
      使い方：検索ボックスで検索するか、地図を動かして緯度経度を取得したい地点を
      <strong>右クリック</strong>してください。その後、CSVなどに貼りつけてご利用ください。<br />
      利用地図：OpenStreetMapを利用しています　&copy;OpenStreetMap Contributors<br />
      利用API：OpenStreetMap Nominatim APIを利用しています。<br />
      作成者：
      <a href="https://x.com/GISPHN" target="_blank" rel="noopener">
        <i class="fa-brands fa-x-twitter"></i> @GISPHN
      </a>
    </p>
  </div>

  <!-- 検索ボックスとスタイル選択をまとめるコンテナ -->
  <div id="controls-container">
    <!-- 検索ボックス -->
    <div class="control-group">
      <input
        type="text"
        id="search-input"
        placeholder="施設名や住所を入力..."
      />
      <button id="search-button">検索</button>
    </div>

    <!-- スタイル切り替え用セレクトボックス -->
    <div class="control-group">
      <label for="style-select">地図スタイル：</label>
      <select id="style-select">
        <option value="https://tile.openstreetmap.jp/styles/osm-bright/style.json">
          OSM Bright
        </option>
        <option value="https://raw.githubusercontent.com/armd-02/Playgrounds/main/tiles/osmfj_poi.json">
          OSMFJ POI
        </option>
      </select>
    </div>
  </div>

  <!-- 地図表示領域 -->
  <div id="map"></div>

  <!-- MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    // 初期地図スタイル (OSM Bright) を設定
    const INITIAL_STYLE = 'https://tile.openstreetmap.jp/styles/osm-bright/style.json';
    
    // 地図の初期化
    const map = new maplibregl.Map({
      container: 'map',
      style: INITIAL_STYLE,
      center: [135.5022, 34.6937], // 大阪市付近 [経度, 緯度]
      zoom: 13
    });

    /**
     * スタイル切り替え
     */
    const styleSelect = document.getElementById('style-select');
    styleSelect.addEventListener('change', () => {
      const newStyleUrl = styleSelect.value;
      map.setStyle(newStyleUrl);
    });

    /**
     * コピー完了を知らせるトースト(ポップアップ)を表示
     * 一定時間後に自動でフェードアウトします
     */
    function showCopyToast(message) {
      // すでにトーストがある場合は削除してから作り直す
      const oldToast = document.querySelector('.copy-toast');
      if (oldToast) {
        document.body.removeChild(oldToast);
      }

      const toast = document.createElement('div');
      toast.className = 'copy-toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      // フェードイン (visibleクラスを付与)
      setTimeout(() => {
        toast.classList.add('visible');
      }, 10);

      // 2秒後にフェードアウト
      setTimeout(() => {
        toast.classList.remove('visible');
      }, 2000);

      // 3秒後にDOMから削除
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 3000);
    }

    // 右クリック時の座標取得イベント
    map.on('contextmenu', (e) => {
      const lng = e.lngLat.lng.toFixed(6);
      const lat = e.lngLat.lat.toFixed(6);

      // 既存のポップアップがあればすべて削除
      const existingPopups = document.querySelectorAll('.maplibregl-popup');
      existingPopups.forEach(popup => popup.remove());

      // 新しくポップアップを生成
      const popup = new maplibregl.Popup({ closeOnClick: false })
        .setLngLat([lng, lat])
        .setHTML(`
          <div class="custom-popup">
            Lat: ${lat}, Lng: ${lng}<br>(クリックでコピー)
          </div>
        `)
        .addTo(map);

      // クリックでコピー -> フェードアウトして自動で消える
      setTimeout(() => {
        const popupContent = popup.getElement().querySelector('.custom-popup');
        if (!popupContent) return;

        popupContent.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(`${lat}, ${lng}`);
            showCopyToast('クリップボードにコピーしました！');
            
            // ポップアップ本体をフェードアウト
            popupContent.classList.add('fade-out');
            setTimeout(() => {
              popup.remove();
            }, 800);
          } catch (err) {
            alert('コピーに失敗しました: ' + err);
          }
        });
      }, 100);
    });

    // 検索ボタンを押したとき
    document.getElementById('search-button').addEventListener('click', () => {
      performSearch();
    });

    // Enterキーでも検索
    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    // Nominatim APIを使った検索
    async function performSearch() {
      const query = document.getElementById('search-input').value.trim();
      if (!query) return;

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Network response was not OK');
        }
        const data = await response.json();
        if (data.length === 0) {
          alert('該当する場所が見つかりませんでした。');
          return;
        }

        // 最初の検索結果を採用
        const result = data[0];
        const lat = parseFloat(result.lat);
        const lon = parseFloat(result.lon);

        map.setCenter([lon, lat]);
        map.setZoom(16);

        // 検索結果の場所にポップアップを表示
        new maplibregl.Popup({ closeOnClick: true })
          .setLngLat([lon, lat])
          .setHTML(`<div class="custom-popup">${result.display_name}</div>`)
          .addTo(map);

      } catch (error) {
        console.error('Error:', error);
        alert('検索に失敗しました。');
      }
    }
  </script>
</body>
</html>
