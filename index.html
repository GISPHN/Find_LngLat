// ソースやレイヤーの情報を用意
const solidLineSource = {
  type: 'geojson',
  data: {
    type: 'Feature',
    geometry: { type: 'LineString', coordinates: [] }
  }
};
const solidLineLayer = {
  id: 'solid-line-layer',
  type: 'line',
  source: 'solid-line-source',
  paint: {
    'line-color': '#0000ff',
    'line-width': 3
  }
};

const dottedLineSource = {
  type: 'geojson',
  data: {
    type: 'FeatureCollection',
    features: []
  }
};
const dottedLineLayer = {
  id: 'dotted-line-layer',
  type: 'line',
  source: 'dotted-line-source',
  paint: {
    'line-color': '#0000ff',
    'line-width': 3,
    'line-dasharray': [2,2]
  }
};

// 地図初期化
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tile.openstreetmap.jp/styles/osm-bright/style.json',
  center: [135.5022, 34.6937],
  zoom: 13
});

// スタイル or ソースが変わるたびに呼ばれる
map.on('styledata', () => {
  // solidLineSource が未登録なら登録
  if (!map.getSource('solid-line-source')) {
    map.addSource('solid-line-source', solidLineSource);
  }
  if (!map.getLayer('solid-line-layer')) {
    map.addLayer(solidLineLayer);
  }

  // dottedLineSource が未登録なら登録
  if (!map.getSource('dotted-line-source')) {
    map.addSource('dotted-line-source', dottedLineSource);
  }
  if (!map.getLayer('dotted-line-layer')) {
    map.addLayer(dottedLineLayer);
  }
});

// スタイル切り替え処理
document.getElementById('style-select').addEventListener('change', (e) => {
  const val = e.target.value;
  if (val.includes('cyberjapandata.gsi.go.jp')) {
    // ラスタースタイルに切り替え
    map.setStyle({
      version: 8,
      sources: {
        'gsi-photo': {
          type: 'raster',
          tiles: [ val ],
          tileSize: 256
        }
      },
      layers: [
        {
          id: 'gsi-photo-layer',
          type: 'raster',
          source: 'gsi-photo',
          minzoom: 0,
          maxzoom: 18
        }
      ]
    });
  } else {
    // ベクトルタイルのstyle.json
    map.setStyle(val);
  }
});
